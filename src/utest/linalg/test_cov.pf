module test_cov
    use pfunit_mod
    use trncmp_ENV

    real(dp), parameter :: MEAN_VEC(4) = [ -2.0432d0, -0.7946d0, -0.6209d0, 0.5114d0 ]

    real(dp), parameter :: TEST_DATA1(4,30) = reshape( [  &
         &  0.67643643d0,  1.65878243d0, -0.64982378d0, -2.84010803d0,  &
         & -6.57134839d0, -0.61156827d0, -1.15065750d0,  3.15959076d0,  &
         & -3.88877928d0, -2.40788800d0, -1.44223547d0,  2.38092134d0,  &
         & -0.90452995d0, -0.26021304d0,  2.18690069d0, -0.47959964d0,  &
         & -2.70568890d0, -0.16699761d0, -2.99380283d0,  0.87404796d0,  &
         & -4.96810566d0, -0.91019578d0, -1.54990497d0,  2.18008758d0,  &
         & -5.15380279d0, -1.65238278d0,  1.32067070d0,  3.10814667d0,  &
         &  0.76115510d0,  0.80737510d0, -0.15515908d0, -2.29630672d0,  &
         & -3.13320057d0,  0.17533089d0, -0.28525777d0,  0.40103718d0,  &
         & -6.07477166d0, -3.32347588d0, -3.06449750d0,  4.76124443d0,  &
         & -1.68287792d0,  0.88634441d0, -0.16113062d0, -0.99683207d0,  &
         & -1.64805967d0, -2.00940299d0,  0.23889908d0,  0.75728119d0,  &
         & -2.59454624d0, -2.07302908d0, -5.10290703d0,  1.72799436d0,  &
         & -1.66820834d0, -2.14423025d0, -1.34290904d0,  0.58355711d0,  &
         &  2.68809550d0,  1.43247797d0,  0.33501313d0, -3.46953943d0,  &
         & -0.30398675d0,  0.52146180d0,  0.58924568d0, -2.10145357d0,  &
         & -1.58889956d0, -1.16311848d0, -3.38193135d0,  0.04854269d0,  &
         & -3.47293002d0, -0.82772445d0, -3.75145960d0,  1.58351630d0,  &
         & -0.14911174d0, -1.67691179d0, -0.53407110d0,  0.06578529d0,  &
         & -0.31345500d0,  0.65180541d0,  1.19106182d0, -1.66056015d0,  &
         & -0.75391260d0, -1.51898584d0,  1.89431606d0,  0.14725332d0,  &
         & -4.58360087d0, -2.07306118d0, -0.63128293d0,  3.20576917d0,  &
         & -0.72022108d0, -0.73163326d0, -2.38672323d0, -0.34457483d0,  &
         & -1.02646619d0, -1.62699791d0,  2.32899829d0, -0.22429320d0,  &
         &  4.09483031d0,  0.12541102d0, -0.19728390d0, -4.41761360d0,  &
         & -1.07717538d0, -0.56776489d0, -0.22511431d0, -0.21404852d0,  &
         & -4.61268794d0, -1.85408507d0,  1.34652399d0,  2.82117893d0,  &
         &  2.16634657d0, -1.66852203d0, -0.59528001d0, -1.78995447d0,  &
         & -3.69914737d0, -0.83633241d0, -0.50335459d0,  1.51180807d0,  &
         & -5.76855370d0, -2.65742006d0, -3.34328199d0,  4.11377333d0   &
         &  ], [4,30])

    real(dp), parameter :: TEST_DATA2(30,4) = transpose( TEST_DATA1 )

    real(dp), parameter :: COV_MATRIX(4,4) = reshape( [  &
         &  6.965564874241d0,  1.826928104374d0,  1.511820018924d0, -5.704594933043d0,  &
         &  1.826928104374d0,  1.605336935245d0,  0.680856275546d0, -2.163550087604d0,  &
         &  1.511820018924d0,  0.680856275546d0,  3.442624268788d0, -1.479698414326d0,  &
         & -5.704594933043d0, -2.163550087604d0, -1.479698414326d0,  5.145183228762d0   &
         &  ], [4,4])
    real(dp), parameter :: COR_MATRIX(4,4) = reshape( [  &
         &  1.000000000000d0,  0.546336463492d0,  0.308728773868d0, -0.952897567845d0,  &
         &  0.546336463492d0,  1.000000000000d0,  0.289619322184d0, -0.752806624653d0,  &
         &  0.308728773868d0,  0.289619322184d0,  1.000000000000d0, -0.351583085132d0,  &
         & -0.952897567845d0, -0.752806624653d0, -0.351583085132d0,  1.000000000000d0   &
         &  ], [4,4])

contains

  @test
  !/ =====================================================================================
  subroutine test_covar
    !/ -----------------------------------------------------------------------------------
    use covariance_mod
    implicit none

    integer :: i, j, ie, nv
    character(:), allocatable :: msg

    real(dp), allocatable :: CM1(:,:)
    real(dp), allocatable :: CM2(:,:)
    real(dp), allocatable :: CR(:,:)

    nv = size(MEAN_VEC)

!    write(*,*) '============'
!    call print_array( MEAN_VEC, FMT='F7.4' )
!    write(*,*) '------------'
!    call print_array( TEST_DATA2, FMT='F11.8' )
!    write(*,*) '------------'
!    call print_array( COV_MATRIX, FMT='F15.12' )
!    write(*,*) '============'

    allocate( CM1(nv,nv) )
     allocate( CM2(nv,nv) )
   allocate( CR(nv,nv) )

    call covariance( CM1, TEST_DATA1, MEAN_VEC, IERR=ie, EMSG=msg )

    @assertEqual( 0, ie )

    call covariance( CM2, TEST_DATA2, MEAN_VEC, IERR=ie, EMSG=msg )

    @assertEqual( 0, ie )

!    call print_array( CM1, FMT='F15.12' )
!    write(*,*) '------------'
!    call print_array( CM2, FMT='F15.12' )
!    write(*,*) '============'

    do i=1,nv
       do j=1,nv
          @assertEqual( CM1(i,j), CM2(i,j), 1.0d-12 )
       end do
    end do
    
    do i=1,nv
       do j=1,nv
          @assertEqual( COV_MATRIX(i,j), CM1(i,j), 1.0d-12 )
       end do
    end do
    
    do i=1,nv
       do j=1,nv
          @assertEqual( COV_MATRIX(i,j), CM2(i,j), 1.0d-12 )
       end do
    end do

    call correlate( CR, CM1 )
    
    do i=1,nv
       do j=1,nv
          @assertEqual( COR_MATRIX(i,j), CR(i,j), 1.0d-12 )
       end do
    end do


    deallocate( CM1 )
    deallocate( CM2 )
    deallocate( CR )
    
  end subroutine test_covar

end module test_cov
